const browserAPI="undefined"!=typeof browser?browser:chrome;browserAPI||console.error("[Topic Manager] Browser API (chrome or browser) not available. Extension will not function.");const CONFIG={RETRY_LIMIT:5,RETRY_DELAY_MS:1e3,DEBOUNCE_DELAY_MS:300,UPDATE_SIDEBAR_DEBOUNCE_MS:500,DRAG_DEBOUNCE_MS:200,DEFAULT_SIDEBAR_POSITION:{top:"4rem",right:"4rem",left:"auto"},SELECTORS:{CHAT_CONTAINER:["main",'[role="main"]',"body"],MESSAGE:"[data-message-id]",CONTENT:".whitespace-pre-wrap",TITLE:["h1","title",'[data-testid="conversation-turn-2"]',".text-2xl",".text-3xl",".text-4xl"]},CLASS_NAMES:{SIDEBAR:"topic-manager",BALL:"ball",BALL_ICON:"ball-icon",SIDEBAR_CONTENT:"sidebar-content",CHAT_TITLE_SECTION:"chat-title-section",THEME_TOGGLE:"theme-toggle",TOPIC_INPUT:"topic-input",ADD_TOPIC_BUTTON:"add-topic-button"}},StorageUtils={getCustomChatTitles(e){browserAPI.storage.local.get(["customChatTitles"],(t=>{e(t.customChatTitles||{})}))},setCustomChatTitle(e,t,o){this.getCustomChatTitles((n=>{n[e]=t,browserAPI.storage.local.set({customChatTitles:n},(()=>{console.log(`Custom title "${t}" saved for conversation ${e}`),o&&o()}))}))},getTopicsByConversation(e){browserAPI.storage.local.get(["topicsByConversation"],(t=>{e(t.topicsByConversation||{})}))},setTopicsByConversation(e,t,o){this.getTopicsByConversation((n=>{n[e]=t,browserAPI.storage.local.set({topicsByConversation:n},(()=>{console.log(`Topics updated for conversation ${e}`),o&&o()}))}))},getBookmarksByConversation(e){browserAPI.storage.local.get(["messageBookmarksByConversation"],(t=>{e(t.messageBookmarksByConversation||{})}))},setBookmarksByConversation(e,t,o){this.getBookmarksByConversation((n=>{n[e]=t,browserAPI.storage.local.set({messageBookmarksByConversation:n},(()=>{console.log(`Bookmarks updated for conversation ${e}`),o&&o()}))}))},getCurrentTopicByConversation(e){browserAPI.storage.local.get(["currentTopicByConversation"],(t=>{e(t.currentTopicByConversation||{})}))},setCurrentTopicByConversation(e,t,o){this.getCurrentTopicByConversation((n=>{n[e]=t,browserAPI.storage.local.set({currentTopicByConversation:n},(()=>{console.log(`Current topic set to ${t} for conversation ${e}`),o&&o()}))}))},getSettings(e){browserAPI.storage.local.get(["autoTopic","topicPosition"],(t=>{e({autoTopic:t.autoTopic||"enabled",topicPosition:t.topicPosition||"right"})}))}};let currentConversationId=null,domMessages=[],lastMessageIds=[],extractTimeout=null,updateTimeout=null,lastCustomTitleConversationId=null,lastCustomTitleValue=null;function getConversationIdFromUrl(){const e=window.location.pathname.match(/\/c\/([a-zA-Z0-9-]+)/);return e?e[1]:null}function extractMessagesFromDOM(){const e=document.querySelectorAll(CONFIG.SELECTORS.MESSAGE),t=[],o=[];e.forEach((e=>{const n=e?.getAttribute("data-message-id");if(!n)return;o.push(n);const i=e.getAttribute("data-message-author-role")||"",s=e.querySelector(CONFIG.SELECTORS.CONTENT),r=s?.textContent||"",a=getConversationIdFromUrl();a&&t.push({id:n,author:i,content:r,node:e,conversationId:a})})),o.join(",")!==lastMessageIds.join(",")&&(lastMessageIds=o,domMessages=t,console.log("[Topic Manager] DOM messages updated:",domMessages))}function debouncedExtractMessages(){clearTimeout(extractTimeout),extractTimeout=setTimeout(extractMessagesFromDOM,CONFIG.DEBOUNCE_DELAY_MS)}function observeChatContainer(){const e=CONFIG.SELECTORS.CHAT_CONTAINER.map((e=>document.querySelector(e))).find((e=>e))||document.body;if(e){new MutationObserver(debouncedExtractMessages).observe(e,{childList:!0,subtree:!0})}}function getChatTitleFromDOM(){const e=document.querySelector('[aria-label="Chat history"] [data-testid="conversation-list"] [aria-current="page"], [aria-label="Chat history"] [data-testid="conversation-list"] .bg-token-sidebar-surface-primary');if(e){const t=e.querySelector("div, span, p");if(t&&t.textContent.trim())return t.textContent.trim()}const t=CONFIG.SELECTORS.TITLE.map((e=>document.querySelector(e))).find((e=>e))||null;if(!t){const e=document.querySelector('[data-message-author-role="user"]');if(e){const t=e.querySelector(CONFIG.SELECTORS.CONTENT);if(t)return t.textContent.trim().split("\n")[0]||"Untitled Chat"}}return t?.textContent?.trim()||"Untitled Chat"}function updateCurrentChat(){const e=getConversationIdFromUrl();e&&e!==currentConversationId&&(currentConversationId=e,console.log("[Topic Manager] Chat changed:",currentConversationId),browserAPI.runtime.sendMessage({type:"CHAT_CHANGED",conversationId:currentConversationId}),updateSidebar())}function getCustomChatTitle(e,t){StorageUtils.getCustomChatTitles((o=>{t(o[e]||null)}))}function setCustomChatTitle(e,t,o){StorageUtils.setCustomChatTitle(e,t,o)}function updateSidebarTitle(){const e=getConversationIdFromUrl();if(!e)return;const t=ensureSidebar().querySelector("#ai-chat-topic-title");t?getCustomChatTitle(e,(e=>{t.textContent=e||getChatTitleFromDOM()})):console.error("[Topic Manager] Chat title element not found in sidebar")}function showTitleEditInput(){if(!getConversationIdFromUrl())return;const e=ensureSidebar(),t=e.querySelector("#ai-chat-topic-title"),o=e.querySelector("#ai-chat-title-edit"),n=e.querySelector("#ai-chat-title-input");t&&o&&n&&(n.value=t.textContent,t.style.display="none",o.style.display="inline",n.focus(),n.select(),n.onblur=saveTitleEdit,n.onkeydown=e=>{"Enter"===e.key?saveTitleEdit():"Escape"===e.key&&cancelTitleEdit()})}function saveTitleEdit(){const e=getConversationIdFromUrl();if(!e)return;const t=ensureSidebar(),o=t.querySelector("#ai-chat-topic-title"),n=t.querySelector("#ai-chat-title-edit"),i=t.querySelector("#ai-chat-title-input");if(o&&n&&i){const t=i.value.trim()||getChatTitleFromDOM();setCustomChatTitle(e,t,(()=>{o.textContent=t,lastCustomTitleConversationId=e,lastCustomTitleValue=t,o.style.display="",n.style.display="none",renderCustomTitleList()}))}}function cancelTitleEdit(){const e=ensureSidebar(),t=e.querySelector("#ai-chat-topic-title"),o=e.querySelector("#ai-chat-title-edit");t&&o&&(t.style.display="",o.style.display="none")}function setupSidebarEventListeners(e){const t=CONFIG.DEBOUNCE_DELAY_MS;let o=0;const n=()=>{e.className=CONFIG.CLASS_NAMES.SIDEBAR,browserAPI.storage.local.set({sidebarState:"expanded"},(()=>{console.log("Sidebar expanded via click/tap")}))};e.querySelector(`.${CONFIG.CLASS_NAMES.BALL_ICON}`)&&(e.addEventListener("click",(t=>{e.classList.contains(CONFIG.CLASS_NAMES.BALL)&&t.target.closest(`.${CONFIG.CLASS_NAMES.BALL_ICON}`)&&n()})),e.addEventListener("touchstart",(i=>{if(e.classList.contains(CONFIG.CLASS_NAMES.BALL)&&i.target.closest(`.${CONFIG.CLASS_NAMES.BALL_ICON}`)){const e=(new Date).getTime(),s=e-o;s<t&&s>0?i.preventDefault():n(),o=e}})));const i=()=>{e.classList.contains(CONFIG.CLASS_NAMES.BALL)||(e.className=`${CONFIG.CLASS_NAMES.SIDEBAR} ${CONFIG.CLASS_NAMES.BALL}`,browserAPI.storage.local.set({sidebarState:"collapsed"},(()=>{console.log("Sidebar collapsed via double-click/tap")})))},s=e.querySelector(`.${CONFIG.CLASS_NAMES.CHAT_TITLE_SECTION}`);s&&(s.addEventListener("dblclick",i),s.addEventListener("touchstart",(e=>{const n=(new Date).getTime(),s=n-o;s<t&&s>0&&i(),o=n})));const r=e.querySelector(".close-icon");r&&r.addEventListener("click",(()=>{e.className=`${CONFIG.CLASS_NAMES.SIDEBAR} ${CONFIG.CLASS_NAMES.BALL}`,browserAPI.storage.local.set({sidebarState:"collapsed"},(()=>{console.log("Sidebar collapsed via close icon")}))}));const a=e.querySelector("#theme-switch");if(a){const u='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="8" r="5"/><line x1="8" y1="1" x2="8" y2="3"/><line x1="8" y1="13" x2="8" y2="15"/><line x1="3.22" y1="3.22" x2="4.64" y2="4.64"/><line x1="11.36" y1="11.36" x2="12.78" y2="12.78"/><line x1="1" y1="8" x2="3" y2="8"/><line x1="13" y1="8" x2="15" y2="8"/><line x1="3.22" y1="12.78" x2="4.64" y2="11.36"/><line x1="11.36" y1="4.64" x2="12.78" y2="3.22"/></svg>',p='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M15 13A6 6 0 1 1 9 3a5 5 0 0 0 6 10z"/></svg>';function l(e){a.innerHTML="dark"===e?u:p}browserAPI.storage.local.get(["theme"],(e=>{const t=e.theme||"dark";document.body.setAttribute("data-theme",t),l(t),a.onclick=()=>{const e="dark"===document.body.getAttribute("data-theme")?"light":"dark";document.body.setAttribute("data-theme",e),browserAPI.storage.local.set({theme:e},(()=>{l(e)}))}}))}const c=e.querySelector(`.${CONFIG.CLASS_NAMES.TOPIC_INPUT}`),d=e.querySelector(`.${CONFIG.CLASS_NAMES.ADD_TOPIC_BUTTON}`);if(c&&d){const g=()=>{const e=c.value.trim();if(!e)return;const t=getConversationIdFromUrl();t&&StorageUtils.getTopicsByConversation((o=>{const n=o[t]||[],i=Date.now().toString(36)+Math.random().toString(36).slice(2,8);n.push({id:i,name:e}),StorageUtils.setTopicsByConversation(t,n,(()=>{c.value="",renderTopicList(),renderUserMessageBookmarks(),console.log(`Topic "${e}" saved for conversation ${t}`)}))}))};d.addEventListener("click",g),c.addEventListener("blur",g),c.addEventListener("keydown",(e=>{"Enter"===e.key&&g()}))}}function ensureSidebar(){let e=document.querySelector(`.${CONFIG.CLASS_NAMES.SIDEBAR}`);if(!e){e=document.createElement("div"),e.className=`${CONFIG.CLASS_NAMES.SIDEBAR} ${CONFIG.CLASS_NAMES.BALL}`,e.innerHTML=`\n            <div class="${CONFIG.CLASS_NAMES.BALL_ICON}">ðŸ’¬</div>\n            <div class="${CONFIG.CLASS_NAMES.SIDEBAR_CONTENT}">\n                <div class="${CONFIG.CLASS_NAMES.CHAT_TITLE_SECTION}">\n                    <span id="ai-chat-topic-title"></span>\n                    <span id="ai-chat-title-edit"><input id="ai-chat-title-input" type="text" /></span>\n                      <span class="edit-icon" title="Edit title">\n                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>\n                    </span>\n                    <div class="${CONFIG.CLASS_NAMES.THEME_TOGGLE}">\n                        <span id="theme-switch"></span>\n                    </div>\n                    <span class="close-icon" title="Minimize">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-minimize"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></svg>\n                    </span>\n                </div>\n                <hr class="sidebar-divider">\n                <div class="topic-input-div">\n                    <input id="ai-topic-input" name="ai-topic-input" class="${CONFIG.CLASS_NAMES.TOPIC_INPUT}" type="text" placeholder="Add new topic..." />\n                    <button class="${CONFIG.CLASS_NAMES.ADD_TOPIC_BUTTON}">Add</button>\n                </div>\n                <div class="topic-list"></div>\n            </div>\n        `,document.body.appendChild(e);const t=e.querySelector(".edit-icon");t&&t.addEventListener("click",showTitleEditInput),setupSidebarEventListeners(e),StorageUtils.getSettings((t=>{const o=CONFIG.DEFAULT_SIDEBAR_POSITION;"left"===t.topicPosition?(o.left="4rem",o.right="auto"):(o.right="4rem",o.left="auto"),browserAPI.storage.local.get(["sidebarState","sidebarPosition"],(t=>{"expanded"===t.sidebarState&&(e.className=CONFIG.CLASS_NAMES.SIDEBAR);const n=t.sidebarPosition||o;e.style.top=n.top||o.top,e.style.left=n.left||o.left,e.style.right=n.right||o.right}))})),makeDraggable(e)}return e}function makeDraggable(e){let t,o,n,i,s,r=!1;function a(t){if(t.target.closest(".topic-input, .add-topic-button, .edit-icon, .topic-bookmark, .topic-select, #ai-chat-title-input, .delete-topic, #theme-switch, .close-icon"))return;t.preventDefault();const o=e.getBoundingClientRect();if("mousedown"===t.type)n=t.clientX-(parseFloat(e.style.left)||window.innerWidth-parseFloat(e.style.right)-o.width),i=t.clientY-(parseFloat(e.style.top)||32);else{const s=t.touches[0];n=s.clientX-(parseFloat(e.style.left)||window.innerWidth-parseFloat(e.style.right)-o.width),i=s.clientY-(parseFloat(e.style.top)||32)}r=!0,e.style.cursor="grabbing"}function l(a){if(!r)return;a.preventDefault();const l=e.getBoundingClientRect();if("mousemove"===a.type)t=a.clientX-n,o=a.clientY-i;else{const e=a.touches[0];t=e.clientX-n,o=e.clientY-i}const c=window.innerWidth-l.width,d=window.innerHeight-l.height;t=Math.max(0,Math.min(t,c)),o=Math.max(0,Math.min(o,d)),t<=window.innerWidth/2?(e.style.left=t+"px",e.style.right="auto"):(e.style.right=window.innerWidth-(t+l.width)+"px",e.style.left="auto"),e.style.top=o+"px",clearTimeout(s),s=setTimeout((()=>{browserAPI.storage.local.set({sidebarPosition:{top:e.style.top,left:e.style.left,right:e.style.right}},(()=>{console.log("Sidebar position updated")}))}),CONFIG.DRAG_DEBOUNCE_MS)}function c(){r=!1,e.style.cursor="grab"}e.addEventListener("mousedown",a),document.addEventListener("mousemove",l),document.addEventListener("mouseup",c),e.addEventListener("touchstart",a),document.addEventListener("touchmove",l),document.addEventListener("touchend",c)}function observeUrlChanges(){let e=window.location.href,t=getConversationIdFromUrl();const o=history.pushState;history.pushState=function(...e){o.apply(this,e),i()};const n=history.replaceState;function i(){if(window.location.href!==e){e=window.location.href;const o=getConversationIdFromUrl();o&&o!==t&&(console.log("[Topic Manager] Chat changed:",o),t=o,currentConversationId=o,updateSidebarTitle(),updateSidebar(),updateCurrentChat())}}history.replaceState=function(...e){n.apply(this,e),i()},window.addEventListener("popstate",i)}function debouncedUpdateSidebar(){clearTimeout(updateTimeout),updateTimeout=setTimeout((()=>{extractMessagesFromDOM(),updateSidebar()}),CONFIG.UPDATE_SIDEBAR_DEBOUNCE_MS)}function deleteTopic(e,t,o){StorageUtils.getTopicsByConversation((n=>{const i=(n[e]||[]).filter((e=>e.id!==t));StorageUtils.getBookmarksByConversation((n=>{const s=n[e]||{};Object.keys(s).forEach((e=>{s[e].topicId===t&&delete s[e].topicId})),StorageUtils.setBookmarksByConversation(e,s,(()=>{StorageUtils.setTopicsByConversation(e,i,o)}))}))}))}function renderTopicList(){const e=getConversationIdFromUrl();if(!e)return;const t=ensureSidebar().querySelector(".topic-list");t&&StorageUtils.getTopicsByConversation((o=>{const n=o[e]||[];StorageUtils.getCurrentTopicByConversation((o=>{const i=o[e]||null;StorageUtils.getBookmarksByConversation((o=>{const s=o[e]||{},r=[],a={};Object.entries(s).forEach((([e,t])=>{t.topicId?(a[t.topicId]||(a[t.topicId]=[]),a[t.topicId].push({msgId:e,...t})):r.push({msgId:e,...t})}));let l="";r.length&&(l+=`\n                        <div class="topic-item no-topic${null===i?" current":""}" data-topic-id="none">\n                            Unassigned\n                        </div>\n                    `,r.forEach((e=>{l+=`\n                            <div class="bookmark-list-item" data-msg-id="${e.msgId}">\n                                ${e.name}\n                            </div>\n                        `}))),n.forEach((e=>{l+=`\n                        <div class="topic-wrapper">\n                            <div class="topic-item${e.id===i?" current":""}" data-topic-id="${e.id}">\n                                <span title="${e.name}">${e.name}</span>\n                                <span class="delete-topic" title="Delete topic"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></span>\n                            </div>\n                            ${(a[e.id]||[]).map((e=>`\n                                <div class="bookmark-list-item" data-msg-id="${e.msgId}">\n                                    ${e.name}\n                                </div>\n                            `)).join("")}\n                        </div>\n                    `})),t.innerHTML=l,t.addEventListener("click",(t=>{const o=t.target.closest(".topic-item"),n=t.target.closest(".delete-topic"),i=t.target.closest(".bookmark-list-item");if(n){t.stopPropagation();const n=o?.dataset.topicId;n&&"none"!==n&&deleteTopic(e,n,(()=>{renderTopicList(),renderUserMessageBookmarks()}))}else if(o){setCurrentTopic("none"===o.dataset.topicId?null:o.dataset.topicId)}else if(i){const e=i.dataset.msgId,t=document.querySelector(`[data-message-id="${e}"]`);t&&t.scrollIntoView({behavior:"smooth"})}}))}))}))}))}function setCurrentTopic(e){const t=getConversationIdFromUrl();t&&StorageUtils.setCurrentTopicByConversation(t,e,(()=>{renderTopicList()}))}function renderUserMessageBookmarks(){document.querySelectorAll(".bookmark-bar").forEach((e=>e.remove()));const e=getConversationIdFromUrl();if(!e)return;let t=0;const o=CONFIG.RETRY_LIMIT;!function n(){StorageUtils.getTopicsByConversation((i=>{const s=i[e]||[];StorageUtils.getBookmarksByConversation((i=>{const r=i[e]||{},a=document.querySelectorAll('[data-message-id][data-message-author-role="user"]');if(!a.length&&t<o)return t++,void setTimeout(n,CONFIG.RETRY_DELAY_MS);a.forEach((t=>{const o=t.getAttribute("data-message-id");t.querySelectorAll(".bookmark-bar").forEach((e=>e.remove()));let n=document.createElement("div");if(n.className="bookmark-bar",t.insertBefore(n,t.firstChild),r[o]){const t=document.createElement("span");t.className="topic-bookmark assigned",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-bookmark"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>',t.title="Edit bookmark",n.appendChild(t);const i=document.createElement("span");i.className="bookmark-label",i.textContent=r[o].name,n.appendChild(i);const a=document.createElement("select");a.className="topic-select",a.innerHTML='<option value="">No Topic</option>'+s.map((e=>`<option value="${e.id}" ${e.id===r[o].topicId?"selected":""}>${e.name}</option>`)).join(""),n.appendChild(a),t.onclick=()=>showBookmarkInput(n,o,r[o].name,s,r[o].topicId),a.onchange=()=>{const t=a.value;StorageUtils.getBookmarksByConversation((n=>{n[e]||(n[e]={}),n[e][o].topicId=t||void 0,StorageUtils.setBookmarksByConversation(e,n[e],(()=>{renderTopicList()}))}))}}else{const e=document.createElement("span");e.className="topic-bookmark",e.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path><line x1="12" y1="7" x2="12" y2="13"></line></svg>',e.title="Add bookmark",n.appendChild(e),e.onclick=()=>showBookmarkInput(n,o,"",s)}}))}))}))}()}function showBookmarkInput(e,t,o,n,i){e.innerHTML="";const s=document.createElement("input");s.className="topic-input-inline",s.type="text",s.placeholder="Bookmark name...",s.value=o,e.appendChild(s);const r=document.createElement("select");function a(){const e=s.value.trim(),o=r.value,n=getConversationIdFromUrl();n&&StorageUtils.getBookmarksByConversation((i=>{i[n]||(i[n]={}),e?i[n][t]={name:e,topicId:o||void 0}:delete i[n][t],StorageUtils.setBookmarksByConversation(n,i[n],(()=>{renderUserMessageBookmarks(),renderTopicList()}))}))}r.className="topic-select",r.innerHTML='<option value="">No Topic</option>'+n.map((e=>`<option value="${e.id}" ${e.id===i?"selected":""}>${e.name}</option>`)).join(""),e.appendChild(r),s.focus(),s.onkeydown=e=>{"Enter"===e.key?a():"Escape"===e.key&&renderUserMessageBookmarks()},s.onblur=a}function renderCustomTitleList(){const e=ensureSidebar().querySelector(".custom-title-list");if(!e)return;const t=getConversationIdFromUrl();StorageUtils.getCustomChatTitles((o=>{e.innerHTML="",Object.entries(o).forEach((([o,n])=>{const i=document.createElement("div");i.className="custom-title-item"+(o===t?" current":""),i.textContent=n,i.title=n,i.onclick=()=>{o!==t&&(window.location.href=`/c/${o}`,currentConversationId=o,setTimeout((()=>{updateCurrentChat(),updateSidebar()}),100))},e.appendChild(i)})),e.style.display=Object.keys(o).length?"":"none"}))}function updateSidebar(e=0){ensureSidebar(),updateSidebarTitle(),renderTopicList();const t=getConversationIdFromUrl(),o=document.querySelectorAll('[data-message-id][data-message-author-role="user"]');t&&0===o.length&&e<20?setTimeout((()=>updateSidebar(e+1)),300):renderUserMessageBookmarks()}function observeUserMessages(){const e=CONFIG.SELECTORS.CHAT_CONTAINER.map((e=>document.querySelector(e))).find((e=>e))||document.body;if(!e)return;let t=getConversationIdFromUrl();const o=new MutationObserver((()=>{const e=getConversationIdFromUrl();e===t?(renderTopicList(),renderUserMessageBookmarks()):t=e}));o.observe(e,{childList:!0,subtree:!0})}function observeTitleChanges(){const e=new MutationObserver((e=>{e.forEach((e=>{"childList"!==e.type&&"characterData"!==e.type||updateSidebarTitle()}))}));CONFIG.SELECTORS.TITLE.forEach((t=>{const o=document.querySelector(t);o&&e.observe(o,{childList:!0,characterData:!0,subtree:!0})}));const t=document.querySelector('[data-message-author-role="user"]');t&&e.observe(t,{childList:!0,characterData:!0,subtree:!0})}function observeChatGPTSidebar(){const e=document.querySelector('[aria-label="Chat history"]');if(!e)return console.debug("[Topic Manager] Chat history not found, will retry"),void setTimeout(observeChatGPTSidebar,1e3);console.debug("[Topic Manager] Setting up click observer for chat history"),e.addEventListener("click",(e=>{e.target.closest('[data-testid="conversation-list"] > div')&&(console.debug("[Topic Manager] Chat item clicked, updating title"),setTimeout(updateSidebarTitle,100))}))}function observeSidebarSelection(){let e=getConversationIdFromUrl(),t=null,o=!1;function n(){const n=document.querySelector('[aria-label="Chat history"] [data-testid="conversation-list"]');n&&!o&&(o=!0,t=new MutationObserver((()=>{const t=getConversationIdFromUrl();t&&t!==e&&(console.log("[Topic Manager] Chat changed:",t),e=t,currentConversationId=t,updateSidebarTitle(),updateSidebar())})),t.observe(n,{childList:!0,subtree:!0,attributes:!0}))}const i=setInterval((()=>{o?clearInterval(i):n()}),500);new MutationObserver((()=>{o||n()})).observe(document.body,{childList:!0,subtree:!0})}function requestPersistentStorage(){navigator.storage&&navigator.storage.persist&&navigator.storage.persist().then((e=>{e?console.log("[Topic Manager] Persistent storage granted"):console.log("[Topic Manager] Persistent storage not granted")}))}function pollForConversationChange(){let e=getConversationIdFromUrl();setInterval((()=>{const t=getConversationIdFromUrl();t&&t!==e&&(console.log("[Topic Manager] Chat changed (poll):",t),e=t,currentConversationId=t,updateSidebarTitle(),updateSidebar())}),500)}function init(){requestPersistentStorage(),console.log("[Topic Manager] Initializing..."),updateCurrentChat(),observeUrlChanges(),observeTitleChanges(),observeChatGPTSidebar(),observeSidebarSelection(),observeUserMessages(),pollForConversationChange();let e=0;const t=CONFIG.RETRY_LIMIT;setTimeout((function o(){CONFIG.SELECTORS.CHAT_CONTAINER.map((e=>document.querySelector(e))).find((e=>e))||e>=t?(ensureSidebar(),updateSidebar(),observeChatContainer()):(e++,setTimeout(o,CONFIG.RETRY_DELAY_MS))}),CONFIG.RETRY_DELAY_MS)}browserAPI.runtime.onMessage.addListener(((e,t,o)=>{if("GET_CURRENT_CHAT_TITLE"===e.type){const e=getConversationIdFromUrl();return e?(StorageUtils.getCustomChatTitles((t=>{const n=t[e]||getChatTitleFromDOM();o({title:n})})),!0):void o({title:"No chat selected"})}"settings-updated"===e.type&&StorageUtils.getSettings((e=>{const t=ensureSidebar();CONFIG.DEFAULT_SIDEBAR_POSITION;"left"===e.topicPosition?(t.style.left="4rem",t.style.right="auto"):(t.style.right="4rem",t.style.left="auto"),browserAPI.storage.local.set({sidebarPosition:{top:t.style.top,left:t.style.left,right:t.style.right}})}))})),init();